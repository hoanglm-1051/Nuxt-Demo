workspace: true

stages:
  - Install
  - Test
  - Build

jobs:
- name: Npm Install
  stage: Install
  image: node:12-alpine
  script:
  - npm install
  cache:
  - key: node_modules_$CI_BRANCH
    paths:
    - demo-app-client/node_modules

- name: Composer Install
  stage: Install
  image: sunasteriskrnd/php-workspace:7.4
  script:
  - composer install
  cache:
  - key: vendor_$CI_BRANCH
    paths:
    - demo-app-server

- name: Test
  stage: Test
  image: node:12-alpine
  script:
  - npm run dev

- name: Build
  stage: Build
  image: sunasteriskrnd/php-workspace:7.4
  services:
  - image: mysql
    name: mysql_test
    environment:
      MYSQL_HOST: 127.0.0.1
      MYSQL_DATABASE: demo-app
      MYSQL_USER: root
      MYSQL_PASSWORD: hoangminh99
  environment:
    APP_ENV: testing
  cache:
  - key: comopser_vendor_$CI_BRANCH
    paths:
      - demo-app-server/vendor
  before_script:
  - cp .env.example .env.testing
  - composer install
  - php artisan key:generate
  - php artisan migrate
  script:
  - composer sniff
  - composer test
  after_script:
  - echo "Finish job"
  only:
    branches:
    - master
    events:
    - pull_request
  except:
    branches:
    - develop
    events:
    - push
